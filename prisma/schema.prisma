// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum SMTPEncryption {
  TLS
  SSL
  NONE
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  PAUSED
  COMPLETED
  FAILED
}

enum EmailStatus {
  QUEUED
  SENDING
  SENT
  FAILED
  BOUNCED
  DELIVERED
}

enum EventType {
  OPENED
  CLICKED
  BOUNCED
  COMPLAINED
  UNSUBSCRIBED
}

enum BounceType {
  HARD
  SOFT
}

enum TranslationStatus {
  PENDING
  TRANSLATED
  REVIEWED
}

enum WinnerMetric {
  OPEN_RATE
  CLICK_RATE
  CONVERSION_RATE
}

enum ABTestStatus {
  RUNNING
  COMPLETED
  CANCELLED
}

enum DripStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

enum DelayUnit {
  HOURS
  DAYS
  WEEKS
}

enum EnrollmentStatus {
  ACTIVE
  PAUSED
  COMPLETED
  EXITED
}

enum ExecutionStatus {
  RUNNING
  COMPLETED
  FAILED
  PAUSED
}

enum ContactStatus {
  SUBSCRIBED
  UNSUBSCRIBED
  BOUNCED
  COMPLAINED
}

enum IntegrationProvider {
  HUBSPOT
  SALESFORCE
  SHOPIFY
  WOOCOMMERCE
  ZAPIER
}

// Core User & Organization Models
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  role          Role      @default(VIEWER)
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts         Account[]
  sessions         Session[]
  organizations    OrganizationMember[]
  templates        Template[]
  templateVersions TemplateVersion[]
  campaigns        Campaign[]
  snippets         Snippet[]
  assets           Asset[]
  twoFactorAuth    TwoFactorAuth?
  auditLogs        AuditLog[]
  notifications    Notification[]

  @@index([email])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Organization {
  id              String   @id @default(cuid())
  name            String
  defaultLanguage String   @default("en")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  members              OrganizationMember[]
  templates            Template[]
  campaigns            Campaign[]
  smtpProfiles         SmtpProfile[]
  snippets             Snippet[]
  assets               Asset[]
  brandKit             BrandKit?
  contactLists         ContactList[]
  segments             Segment[]
  integrations         Integration[]
  webhookSubscriptions WebhookSubscription[]
  whiteLabelSettings   WhiteLabelSettings?
  apiKeys              APIKey[]
  auditLogs            AuditLog[]
  dripCampaigns        DripCampaign[]
  workflows            Workflow[]
  customVariables      CustomVariable[]
  notifications        Notification[]

  @@map("organizations")
}

model OrganizationMember {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  role           Role
  joinedAt       DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_members")
}

// Template Models
model Template {
  id              String   @id @default(cuid())
  organizationId  String
  name            String
  description     String?  @db.Text
  thumbnail       String?
  structure       Json? // Legacy: kept for backwards compatibility and migration
  cssOverrides    String?  @db.Text
  defaultLanguage String   @default("en")
  isPublished     Boolean  @default(false)
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization       Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator            User               @relation(fields: [createdBy], references: [id])
  versions           TemplateVersion[]
  translations       Translation[]
  campaigns          Campaign[]
  abTestsVariantA    ABTest[]           @relation("ABTestVariantA")
  abTestsVariantB    ABTest[]           @relation("ABTestVariantB")
  dripSteps          DripStep[]
  languageStructures TemplateLanguage[]
  emailLogs          EmailLog[]

  @@index([organizationId])
  @@index([createdBy])
  @@index([isPublished])
  @@map("templates")
}

// Template Language Structures - scalable storage for template content per language
model TemplateLanguage {
  id           String   @id @default(cuid())
  templateId   String
  languageCode String
  structure    Json // EmailBuilderDocument structure for this language
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageCode], references: [code], onDelete: Cascade)

  @@unique([templateId, languageCode])
  @@index([templateId])
  @@index([languageCode])
  @@map("template_languages")
}

model TemplateVersion {
  id            String   @id @default(cuid())
  templateId    String
  versionNumber Int
  structure     Json
  notes         String?  @db.Text
  createdBy     String
  createdAt     DateTime @default(now())

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  creator  User     @relation(fields: [createdBy], references: [id])

  @@unique([templateId, versionNumber])
  @@index([templateId])
  @@index([createdBy])
  @@map("template_versions")
}

// Translation Models
model Language {
  code     String  @id
  name     String
  isActive Boolean @default(true)

  translations      Translation[]
  templateLanguages TemplateLanguage[]

  @@map("languages")
}

model Translation {
  id             String            @id @default(cuid())
  templateId     String
  languageCode   String
  blockId        String
  translationKey String
  translatedText String            @db.Text
  status         TranslationStatus @default(PENDING)
  updatedAt      DateTime          @updatedAt

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageCode], references: [code], onDelete: Cascade)

  @@unique([templateId, languageCode, blockId, translationKey])
  @@index([templateId])
  @@index([languageCode])
  @@map("translations")
}

// Email Infrastructure
model SmtpProfile {
  id             String         @id @default(cuid())
  organizationId String
  name           String
  host           String
  port           Int
  username       String
  password       String // Encrypted
  encryption     SMTPEncryption @default(TLS)
  fromEmail      String
  fromName       String?
  replyTo        String?
  isActive       Boolean        @default(true)
  isDefault      Boolean        @default(false)
  maxHourlyRate  Int?
  testedAt       DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campaigns    Campaign[]

  @@index([organizationId])
  @@index([isActive])
  @@map("smtp_profiles")
}

model Campaign {
  id             String         @id @default(cuid())
  organizationId String
  templateId     String
  smtpProfileId  String?
  name           String
  subject        String
  status         CampaignStatus @default(DRAFT)
  recipientCount Int            @default(0)
  scheduledAt    DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  progress       Float          @default(0)
  sentCount      Int            @default(0)
  failedCount    Int            @default(0)
  createdBy      String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template           Template            @relation(fields: [templateId], references: [id])
  smtpProfile        SmtpProfile?        @relation(fields: [smtpProfileId], references: [id])
  creator            User                @relation(fields: [createdBy], references: [id])
  emailLogs          EmailLog[]
  abTests            ABTest[]
  unsubscribeRecords UnsubscribeRecord[]
  recipients         CampaignRecipient[]

  @@index([organizationId])
  @@index([templateId])
  @@index([status])
  @@index([scheduledAt])
  @@index([createdBy])
  @@map("campaigns")
}

// Campaign Recipients - stores recipients for each campaign
model CampaignRecipient {
  id         String   @id @default(cuid())
  campaignId String
  email      String
  name       String?
  variables  Json?    // Custom variables for this recipient
  createdAt  DateTime @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([email])
  @@map("campaign_recipients")
}

model EmailLog {
  id             String      @id @default(cuid())
  campaignId     String?
  templateId     String
  recipientEmail String
  languageCode   String      @default("en")
  variables      Json?
  status         EmailStatus @default(QUEUED)
  smtpResponse   String?     @db.Text
  errorMessage   String?     @db.Text
  retryCount     Int         @default(0)
  sentAt         DateTime?
  deliveredAt    DateTime?
  createdAt      DateTime    @default(now())

  campaign Campaign?    @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  template Template     @relation(fields: [templateId], references: [id], onDelete: Cascade)
  events   EmailEvent[]

  @@index([campaignId])
  @@index([templateId])
  @@index([recipientEmail])
  @@index([status])
  @@index([sentAt])
  @@map("email_logs")
}

model EmailEvent {
  id         String    @id @default(cuid())
  emailLogId String
  eventType  EventType
  metadata   Json?
  timestamp  DateTime  @default(now())

  emailLog EmailLog @relation(fields: [emailLogId], references: [id], onDelete: Cascade)

  @@index([emailLogId])
  @@index([eventType])
  @@index([timestamp])
  @@map("email_events")
}

// Deliverability
model BounceRecord {
  email          String     @id
  bounceType     BounceType
  bounceReason   String?    @db.Text
  bounceCount    Int        @default(1)
  firstBouncedAt DateTime   @default(now())
  lastBouncedAt  DateTime   @updatedAt
  isSuppressed   Boolean    @default(false)

  @@map("bounce_records")
}

model UnsubscribeRecord {
  id             String   @id @default(cuid())
  email          String
  campaignId     String?
  reason         String?  @db.Text
  ipAddress      String?
  unsubscribedAt DateTime @default(now())

  campaign Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([campaignId])
  @@map("unsubscribe_records")
}

// Content Management
model Snippet {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?  @db.Text
  category       String?
  structure      Json
  thumbnail      String?
  isGlobal       Boolean  @default(false)
  createdBy      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator      User         @relation(fields: [createdBy], references: [id])

  @@index([organizationId])
  @@index([category])
  @@map("snippets")
}

model Asset {
  id               String   @id @default(cuid())
  organizationId   String
  filename         String
  originalFilename String
  fileSize         Int
  mimeType         String
  url              String
  folderPath       String?
  altText          String?
  uploadedBy       String
  createdAt        DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploader     User         @relation(fields: [uploadedBy], references: [id])

  @@index([organizationId])
  @@index([mimeType])
  @@map("assets")
}

model BrandKit {
  id             String  @id @default(cuid())
  organizationId String  @unique
  logoUrl        String?
  colors         Json?
  fonts          Json?
  socialLinks    Json?
  companyInfo    Json?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("brand_kits")
}

// Advanced Features
model ABTest {
  id                 String       @id @default(cuid())
  campaignId         String
  variantATemplateId String
  variantBTemplateId String
  splitPercentage    Int          @default(50)
  winnerMetric       WinnerMetric
  testDuration       Int? // hours
  status             ABTestStatus @default(RUNNING)
  winnerVariant      String? // 'A' or 'B'
  startedAt          DateTime?
  endedAt            DateTime?

  campaign         Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  variantATemplate Template @relation("ABTestVariantA", fields: [variantATemplateId], references: [id])
  variantBTemplate Template @relation("ABTestVariantB", fields: [variantBTemplateId], references: [id])

  @@index([campaignId])
  @@index([status])
  @@map("ab_tests")
}

model DripCampaign {
  id             String     @id @default(cuid())
  organizationId String
  name           String
  status         DripStatus @default(DRAFT)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  steps        DripStep[]
  enrollments  DripEnrollment[]

  @@index([organizationId])
  @@index([status])
  @@map("drip_campaigns")
}

model DripStep {
  id             String    @id @default(cuid())
  dripCampaignId String
  order          Int
  templateId     String
  delayValue     Int
  delayUnit      DelayUnit
  conditions     Json?

  dripCampaign DripCampaign @relation(fields: [dripCampaignId], references: [id], onDelete: Cascade)
  template     Template     @relation(fields: [templateId], references: [id])

  @@index([dripCampaignId])
  @@index([order])
  @@map("drip_steps")
}

model DripEnrollment {
  id             String           @id @default(cuid())
  dripCampaignId String
  recipientEmail String
  variables      Json?
  currentStep    Int              @default(0)
  enrolledAt     DateTime         @default(now())
  nextSendAt     DateTime?
  status         EnrollmentStatus @default(ACTIVE)

  dripCampaign DripCampaign @relation(fields: [dripCampaignId], references: [id], onDelete: Cascade)

  @@index([dripCampaignId])
  @@index([recipientEmail])
  @@index([status])
  @@index([nextSendAt])
  @@map("drip_enrollments")
}

model Workflow {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?  @db.Text
  trigger        Json
  nodes          Json
  isActive       Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  executions   WorkflowExecution[]

  @@index([organizationId])
  @@index([isActive])
  @@map("workflows")
}

model WorkflowExecution {
  id          String          @id @default(cuid())
  workflowId  String
  contactId   String?
  status      ExecutionStatus @default(RUNNING)
  currentNode String?
  startedAt   DateTime        @default(now())
  completedAt DateTime?

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([status])
  @@map("workflow_executions")
}

// Contact Management
model ContactList {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?  @db.Text
  tags           String[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contacts     Contact[]

  @@index([organizationId])
  @@map("contact_lists")
}

model Contact {
  id             String        @id @default(cuid())
  listId         String
  email          String
  firstName      String?
  lastName       String?
  customFields   Json?
  status         ContactStatus @default(SUBSCRIBED)
  subscribedAt   DateTime      @default(now())
  unsubscribedAt DateTime?

  list ContactList @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@index([listId])
  @@index([email])
  @@index([status])
  @@map("contacts")
}

model Segment {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  conditions     Json
  contactCount   Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("segments")
}

// Integration & Settings
model Integration {
  id             String              @id @default(cuid())
  organizationId String
  provider       IntegrationProvider
  accessToken    String              @db.Text // Encrypted
  refreshToken   String?             @db.Text // Encrypted
  expiresAt      DateTime?
  settings       Json?
  isActive       Boolean             @default(true)
  connectedAt    DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([provider])
  @@map("integrations")
}

model WebhookSubscription {
  id             String   @id @default(cuid())
  organizationId String
  url            String
  events         String[]
  secret         String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([isActive])
  @@map("webhook_subscriptions")
}

model WhiteLabelSettings {
  organizationId String   @id @unique
  customDomain   String?
  logoUrl        String?
  primaryColor   String?
  secondaryColor String?
  faviconUrl     String?
  customCSS      String?  @db.Text
  termsUrl       String?
  privacyUrl     String?
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("white_label_settings")
}

model TwoFactorAuth {
  userId      String    @id
  secret      String
  isEnabled   Boolean   @default(false)
  backupCodes String[] // Encrypted
  enabledAt   DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_factor_auth")
}

model APIKey {
  id             String    @id @default(cuid())
  organizationId String
  name           String
  keyHash        String
  permissions    String[]
  lastUsedAt     DateTime?
  createdAt      DateTime  @default(now())
  expiresAt      DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([keyHash])
  @@map("api_keys")
}

model AuditLog {
  id             String   @id @default(cuid())
  userId         String?
  organizationId String?
  action         String
  resourceType   String?
  resourceId     String?
  changes        Json?
  ipAddress      String?
  userAgent      String?
  timestamp      DateTime @default(now())

  user         User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([organizationId])
  @@index([timestamp])
  @@index([action])
  @@map("audit_logs")
}

// Custom Variables
model CustomVariable {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  path           String // e.g., "custom.discountCode" or "custom.promo"
  description    String?  @db.Text
  type           String   @default("string") // string, number, boolean, object, array
  sampleValue    Json?
  category       String   @default("Custom")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, path])
  @@index([organizationId])
  @@map("custom_variables")
}

// Notifications
model Notification {
  id             String   @id @default(cuid())
  userId         String
  organizationId String?
  type           String   // 'campaign_completed', 'campaign_failed', 'email_bounced', 'template_updated', etc.
  title          String
  message        String   @db.Text
  link           String?  // Optional link to related resource
  isRead         Boolean  @default(false)
  metadata       Json?    // Additional data (campaignId, templateId, etc.)
  createdAt      DateTime @default(now())
  readAt         DateTime?

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}
